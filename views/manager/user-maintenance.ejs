<%- include('../partials/header', { title: 'User Maintenance - Ella Rises', user: typeof user !== 'undefined' ? user : null }) %>

<div class="page-header">
    <h1>User Maintenance</h1>
    <p>Manage Admin and Volunteer roles</p>
</div>

<% if (messages && messages.length > 0) { %>
    <% messages.forEach(function(message) { %>
        <div class="flash-message flash-<%= message.type %>" style="max-width: 1200px; margin: 1rem auto; padding: 0 2rem;">
            <%= message.text %>
        </div>
    <% }); %>
<% } %>

<div class="container-fluid" style="max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
    <div class="row" style="gap: 2rem;">
        <!-- Admins Column -->
        <div class="col-md-6" style="padding: 0;">
            <div style="background: var(--white); border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-dark);">Admins</h2>
                
                <!-- Search Bar for Admins -->
                <div style="position: relative; margin-bottom: 1.5rem;">
                    <label for="adminSearch" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">Add Admin</label>
                    <input 
                        type="text" 
                        id="adminSearch" 
                        class="form-control" 
                        placeholder="Search people to add as Admin..." 
                        autocomplete="off"
                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-light); border-radius: 4px;"
                    >
                    <div id="adminSearchResults" class="list-group" style="position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-top: none; display: none; background: var(--white); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <!-- Search results will be appended here -->
                    </div>
                </div>

                <!-- Admins Table -->
                <div class="table-container">
                    <table class="table table-striped" style="margin-bottom: 0;">
                        <thead>
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col">Email</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminsTableBody">
                            <% if (typeof admins !== 'undefined' && admins.length > 0) { %>
                                <% admins.forEach(function(admin) { %>
                                    <tr>
                                        <td><%= (admin.firstname || '') + ' ' + (admin.lastname || '') %></td>
                                        <td><%= admin.email || 'N/A' %></td>
                                        <td>
                                            <div class="action-buttons">
                                                <form action="/user-maintenance/remove-admin" method="POST" style="display: inline;">
                                                    <input type="hidden" name="personid" value="<%= admin.personid %>">
                                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to remove Admin role from this person?');">Remove Admin Role</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="3" class="text-center" style="color: var(--text-secondary); padding: 2rem;">No admins found.</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Volunteers Column -->
        <div class="col-md-6" style="padding: 0;">
            <div style="background: var(--white); border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2 style="margin-top: 0; margin-bottom: 1rem; color: var(--text-dark);">Volunteers</h2>
                
                <!-- Search Bar for Volunteers -->
                <div style="position: relative; margin-bottom: 1.5rem;">
                    <label for="volunteerSearch" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">Add Volunteer</label>
                    <input 
                        type="text" 
                        id="volunteerSearch" 
                        class="form-control" 
                        placeholder="Search people to add as Volunteer..." 
                        autocomplete="off"
                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-light); border-radius: 4px;"
                    >
                    <div id="volunteerSearchResults" class="list-group" style="position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-top: none; display: none; background: var(--white); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <!-- Search results will be appended here -->
                    </div>
                </div>

                <!-- Volunteers Table -->
                <div class="table-container">
                    <table class="table table-striped" style="margin-bottom: 0;">
                        <thead>
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col">Email</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="volunteersTableBody">
                            <% if (typeof volunteers !== 'undefined' && volunteers.length > 0) { %>
                                <% volunteers.forEach(function(volunteer) { %>
                                    <tr>
                                        <td><%= (volunteer.firstname || '') + ' ' + (volunteer.lastname || '') %></td>
                                        <td><%= volunteer.email || 'N/A' %></td>
                                        <td>
                                            <div class="action-buttons">
                                                <form action="/user-maintenance/remove-volunteer" method="POST" style="display: inline;">
                                                    <input type="hidden" name="personid" value="<%= volunteer.personid %>">
                                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to remove Volunteer role from this person?');">Remove Volunteer Role</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="3" class="text-center" style="color: var(--text-secondary); padding: 2rem;">No volunteers found.</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden forms for adding roles -->
<form id="addAdminForm" action="/user-maintenance/add-admin" method="POST" style="display: none;">
    <input type="hidden" name="personid" id="addAdminPersonId">
</form>

<form id="addVolunteerForm" action="/user-maintenance/add-volunteer" method="POST" style="display: none;">
    <input type="hidden" name="personid" id="addVolunteerPersonId">
</form>

<script>
(function() {
    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Admin search functionality
    const adminSearch = document.getElementById('adminSearch');
    const adminSearchResults = document.getElementById('adminSearchResults');
    let adminSearchTimeout;

    function performAdminSearch(term) {
        if (!term || term.trim().length === 0) {
            adminSearchResults.style.display = 'none';
            adminSearchResults.innerHTML = '';
            return;
        }

        fetch(`/user-maintenance/search/admin?term=${encodeURIComponent(term)}`)
            .then(response => response.json())
            .then(data => {
                adminSearchResults.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(person => {
                        const div = document.createElement('div');
                        div.classList.add('list-group-item', 'list-group-item-action');
                        div.style.cursor = 'pointer';
                        div.style.padding = '0.75rem 1rem';
                        div.innerHTML = `<strong>${person.name}</strong><br><small style="color: var(--text-secondary);">${person.email}</small>`;
                        div.addEventListener('click', () => {
                            document.getElementById('addAdminPersonId').value = person.personid;
                            document.getElementById('addAdminForm').submit();
                        });
                        adminSearchResults.appendChild(div);
                    });
                    adminSearchResults.style.display = 'block';
                } else {
                    adminSearchResults.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error searching admins:', error);
                adminSearchResults.style.display = 'none';
            });
    }

    adminSearch.addEventListener('input', function(e) {
        const term = e.target.value;
        clearTimeout(adminSearchTimeout);
        adminSearchTimeout = setTimeout(() => performAdminSearch(term), 200);
    });

    adminSearch.addEventListener('focus', function(e) {
        if (e.target.value.trim().length > 0) {
            performAdminSearch(e.target.value);
        }
    });

    adminSearch.addEventListener('blur', function() {
        setTimeout(() => {
            if (!adminSearchResults.contains(document.activeElement)) {
                adminSearchResults.style.display = 'none';
            }
        }, 200);
    });

    // Volunteer search functionality
    const volunteerSearch = document.getElementById('volunteerSearch');
    const volunteerSearchResults = document.getElementById('volunteerSearchResults');
    let volunteerSearchTimeout;

    function performVolunteerSearch(term) {
        if (!term || term.trim().length === 0) {
            volunteerSearchResults.style.display = 'none';
            volunteerSearchResults.innerHTML = '';
            return;
        }

        fetch(`/user-maintenance/search/volunteer?term=${encodeURIComponent(term)}`)
            .then(response => response.json())
            .then(data => {
                volunteerSearchResults.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(person => {
                        const div = document.createElement('div');
                        div.classList.add('list-group-item', 'list-group-item-action');
                        div.style.cursor = 'pointer';
                        div.style.padding = '0.75rem 1rem';
                        div.innerHTML = `<strong>${person.name}</strong><br><small style="color: var(--text-secondary);">${person.email}</small>`;
                        div.addEventListener('click', () => {
                            document.getElementById('addVolunteerPersonId').value = person.personid;
                            document.getElementById('addVolunteerForm').submit();
                        });
                        volunteerSearchResults.appendChild(div);
                    });
                    volunteerSearchResults.style.display = 'block';
                } else {
                    volunteerSearchResults.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error searching volunteers:', error);
                volunteerSearchResults.style.display = 'none';
            });
    }

    volunteerSearch.addEventListener('input', function(e) {
        const term = e.target.value;
        clearTimeout(volunteerSearchTimeout);
        volunteerSearchTimeout = setTimeout(() => performVolunteerSearch(term), 200);
    });

    volunteerSearch.addEventListener('focus', function(e) {
        if (e.target.value.trim().length > 0) {
            performVolunteerSearch(e.target.value);
        }
    });

    volunteerSearch.addEventListener('blur', function() {
        setTimeout(() => {
            if (!volunteerSearchResults.contains(document.activeElement)) {
                volunteerSearchResults.style.display = 'none';
            }
        }, 200);
    });
})();
</script>

<style>
.list-group-item:hover {
    background-color: var(--coral-light);
    color: var(--white);
}

.list-group-item {
    border-bottom: 1px solid var(--border-light);
}

.list-group-item:last-child {
    border-bottom: none;
}

@media (max-width: 768px) {
    .row {
        flex-direction: column;
    }
    
    .col-md-6 {
        width: 100%;
        margin-bottom: 2rem;
    }
}
</style>

<%- include('../partials/footer') %>

