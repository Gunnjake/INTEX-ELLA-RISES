<%- include('../partials/header', { title: 'User Maintenance - Ella Rises', user: typeof user !== 'undefined' ? user : null }) %>

<div class="page-header">
    <h1>User Maintenance</h1>
    <p>Manage admins and volunteers</p>
</div>

<% if (messages && messages.length > 0) { %>
    <% messages.forEach(function(message) { %>
        <div class="flash-message flash-<%= message.type %>" style="max-width: 1200px; margin: 1rem auto; padding: 0 2rem;">
            <%= message.text %>
        </div>
    <% }); %>
<% } %>

<!-- Role Management Buttons -->
<div class="role-buttons" style="margin-top: 20px; display: flex; gap: 10px; margin-bottom: 2rem;">
    <button class="btn btn-primary" onclick="openAddAdminModal()">Add Admin</button>
    <button class="btn btn-primary" onclick="openAddVolunteerModal()">Add Volunteer</button>
</div>

<!-- Admins table -->
<h2 style="margin-top: 2rem; margin-bottom: 1rem;">Admins</h2>

<!-- Add Admin Search Bar -->
<div style="position: relative; margin-bottom: 1rem; max-width: 500px;">
    <label for="admin-search" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Add Admin</label>
    <input 
        type="text" 
        id="admin-search" 
        class="form-control" 
        placeholder="Search by name or email..." 
        autocomplete="off"
        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-light); border-radius: 4px;"
    >
    <div class="search-results" id="admin-results"></div>
</div>

<!-- Add Admin Form -->
<form id="add-admin-form" method="POST" action="/users/add-admin" style="display: none;">
    <input type="hidden" id="add-admin-personid" name="personid">
</form>

<div class="table-container" role="region" aria-label="Admins table">
    <table class="table table-striped" aria-label="Admins">
        <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Email</th>
                <th scope="col">Phone</th>
                <th scope="col">Location</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody id="admins-table-body">
            <% if (typeof admins !== 'undefined' && admins.length > 0) { %>
                <% admins.forEach(function(a) { %>
                    <tr>
                        <td><%= (a.firstname || '') + ' ' + (a.lastname || '') %></td>
                        <td><%= a.email || '' %></td>
                        <td><%= a.phonenumber || '' %></td>
                        <td><%= (a.city || '') + (a.city && a.state ? ', ' : '') + (a.state || '') %></td>
                        <td>
                            <div class="action-buttons">
                                <form method="POST" action="/users/remove-admin" style="display: inline;">
                                    <input type="hidden" name="personid" value="<%= a.personid %>">
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to remove Admin role from this person?');">Remove</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                <% }); %>
            <% } else { %>
                <tr>
                    <td colspan="5" class="text-center" role="status" aria-live="polite">No admins found.</td>
                </tr>
            <% } %>
        </tbody>
    </table>
</div>

<!-- Volunteers table -->
<h2 style="margin-top: 2rem; margin-bottom: 1rem;">Volunteers</h2>

<!-- Add Volunteer Search Bar -->
<div style="position: relative; margin-bottom: 1rem; max-width: 500px;">
    <label for="volunteer-search" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Add Volunteer</label>
    <input 
        type="text" 
        id="volunteer-search" 
        class="form-control" 
        placeholder="Search by name or email..." 
        autocomplete="off"
        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-light); border-radius: 4px;"
    >
    <div class="search-results" id="volunteer-results"></div>
</div>

<!-- Add Volunteer Form -->
<form id="add-volunteer-form" method="POST" action="/users/add-volunteer" style="display: none;">
    <input type="hidden" id="add-volunteer-personid" name="personid">
</form>

<div class="table-container" role="region" aria-label="Volunteers table">
    <table class="table table-striped" aria-label="Volunteers">
        <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Email</th>
                <th scope="col">Phone</th>
                <th scope="col">Location</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody id="volunteers-table-body">
            <% if (typeof volunteers !== 'undefined' && volunteers.length > 0) { %>
                <% volunteers.forEach(function(v) { %>
                    <tr>
                        <td><%= (v.firstname || '') + ' ' + (v.lastname || '') %></td>
                        <td><%= v.email || '' %></td>
                        <td><%= v.phonenumber || '' %></td>
                        <td><%= (v.city || '') + (v.city && v.state ? ', ' : '') + (v.state || '') %></td>
                        <td>
                            <div class="action-buttons">
                                <form method="POST" action="/users/remove-volunteer" style="display: inline;">
                                    <input type="hidden" name="personid" value="<%= v.personid %>">
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to remove Volunteer role from this person?');">Remove</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                <% }); %>
            <% } else { %>
                <tr>
                    <td colspan="5" class="text-center" role="status" aria-live="polite">No volunteers found.</td>
                </tr>
            <% } %>
        </tbody>
    </table>
</div>

<style>
.search-results {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: none;
}

.search-results div {
    padding: 8px 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.search-results div:hover {
    background: #ffd6d6;
}

.search-results div:last-child {
    border-bottom: none;
}
</style>

<script>
function setupLiveSearch(inputId, resultsId, endpoint, formId, hiddenInputId) {
    const input = document.getElementById(inputId);
    const results = document.getElementById(resultsId);

    input.addEventListener('keyup', async () => {
        const term = input.value.trim();
        if (!term) {
            results.innerHTML = '';
            results.style.display = 'none';
            return;
        }

        try {
            const res = await fetch(`${endpoint}?term=${encodeURIComponent(term)}`);
            const data = await res.json();

            results.innerHTML = '';
            if (data.length > 0) {
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.textContent = `${item.name} (${item.email})`;
                    div.onclick = () => {
                        document.getElementById(hiddenInputId).value = item.personid;
                        document.getElementById(formId).submit();
                    };
                    results.appendChild(div);
                });
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        } catch (error) {
            console.error('Error searching:', error);
            results.style.display = 'none';
        }
    });

    // Hide results when clicking outside
    document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !results.contains(e.target)) {
            results.style.display = 'none';
        }
    });
}

setupLiveSearch(
    "admin-search", "admin-results",
    "/users/search/admin",
    "add-admin-form", "add-admin-personid"
);

setupLiveSearch(
    "volunteer-search", "volunteer-results",
    "/users/search/volunteer",
    "add-volunteer-form", "add-volunteer-personid"
);

function openAddAdminModal() {
    document.getElementById('addAdminModal').classList.remove('hidden');
}

function closeAddAdminModal() {
    document.getElementById('addAdminModal').classList.add('hidden');
}

function openAddVolunteerModal() {
    document.getElementById('addVolunteerModal').classList.remove('hidden');
}

function closeAddVolunteerModal() {
    document.getElementById('addVolunteerModal').classList.add('hidden');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const adminModal = document.getElementById('addAdminModal');
    const volunteerModal = document.getElementById('addVolunteerModal');
    
    if (event.target === adminModal) {
        closeAddAdminModal();
    }
    if (event.target === volunteerModal) {
        closeAddVolunteerModal();
    }
});
</script>

<!-- ADD ADMIN MODAL -->
<div id="addAdminModal" class="modal hidden">
    <div class="modal-content">
        <h3 style="margin-top: 0; margin-bottom: 1rem;">Add New Admin</h3>
        <form action="/users/add-admin-manual" method="POST">
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="firstname" placeholder="First Name" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="lastname" placeholder="Last Name" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="email" name="email" placeholder="Email" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="phonenumber" placeholder="Phone Number" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="city" placeholder="City" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <select name="state" required class="form-control" style="width: 100%; padding: 0.75rem;">
                    <option value="">Select State</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                    <option value="DC">District of Columbia</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="zip" placeholder="Zip Code" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="country" placeholder="Country" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button type="button" onclick="closeAddAdminModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- ADD VOLUNTEER MODAL -->
<div id="addVolunteerModal" class="modal hidden">
    <div class="modal-content">
        <h3 style="margin-top: 0; margin-bottom: 1rem;">Add New Volunteer</h3>
        <form action="/users/add-volunteer-manual" method="POST">
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="firstname" placeholder="First Name" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="lastname" placeholder="Last Name" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="email" name="email" placeholder="Email" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="phonenumber" placeholder="Phone Number" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="city" placeholder="City" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <select name="state" required class="form-control" style="width: 100%; padding: 0.75rem;">
                    <option value="">Select State</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                    <option value="DC">District of Columbia</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="zip" placeholder="Zip Code" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <input type="text" name="country" placeholder="Country" required class="form-control" style="width: 100%; padding: 0.75rem;">
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button type="button" onclick="closeAddVolunteerModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<style>
.modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.4);
    z-index: 2000;
}

.modal.hidden {
    display: none;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 350px;
    max-width: 90%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
</style>

<%- include('../partials/footer') %>
