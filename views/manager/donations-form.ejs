<%- include('../partials/header', { title: 'Add New Donation - Ella Rises', user: user || null }) %>

<div class="page-header">
    <h1>Add New Donation</h1>
    <p>Record a new donation</p>
</div>

<% if (messages && messages.length > 0) { %>
    <% messages.forEach(function(message) { %>
        <div class="flash-message flash-<%= message.type %>" style="max-width: 1200px; margin: 1rem auto; padding: 0 2rem;">
            <%= message.text %>
        </div>
    <% }); %>
<% } %>

<div class="form-container" style="max-width: 800px; margin: 0 auto; padding: 0 2rem;">
    <form action="/donations/add" method="POST" class="form">
        <h2>Add Donation</h2>

        <!-- OPTION A: SEARCH EXISTING PERSON -->
        <div class="form-group" style="margin-bottom: 2rem;">
            <label for="personSearch">Select Existing Person</label>
            <input 
                type="text" 
                id="personSearch" 
                placeholder="Search by name or email" 
                class="form-control"
                autocomplete="off"
            >
            <input type="hidden" id="personid" name="personid">
            <div id="personResults" class="autocomplete" style="position: relative;"></div>
            <div id="selectedPerson" style="margin-top: 0.5rem; padding: 0.5rem; background: #f0f0f0; border-radius: 4px; display: none;">
                <strong>Selected:</strong> <span id="selectedPersonName"></span>
                <button type="button" onclick="clearSelection()" style="margin-left: 1rem; padding: 0.25rem 0.5rem; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Clear</button>
            </div>
        </div>

        <hr style="margin: 2rem 0;">

        <!-- OPTION B: CREATE NEW PERSON -->
        <h3 style="margin-bottom: 1rem;">Or Add a New Person</h3>

        <div class="form-group">
            <label for="new_firstname">First Name</label>
            <input type="text" id="new_firstname" name="new_firstname" placeholder="First Name" class="form-control">
        </div>

        <div class="form-group">
            <label for="new_lastname">Last Name</label>
            <input type="text" id="new_lastname" name="new_lastname" placeholder="Last Name" class="form-control">
        </div>

        <div class="form-group">
            <label for="new_email">Email</label>
            <input type="email" id="new_email" name="new_email" placeholder="Email" class="form-control">
        </div>

        <div class="form-group">
            <label for="new_phone">Phone Number</label>
            <input type="text" id="new_phone" name="new_phone" placeholder="Phone Number" class="form-control">
        </div>

        <div class="form-group">
            <label for="new_city">City</label>
            <input type="text" id="new_city" name="new_city" placeholder="City" class="form-control">
        </div>

        <div class="form-group">
            <label for="new_state">State</label>
            <select id="new_state" name="new_state" class="form-control">
                <option value="">Select State</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
                <option value="DC">District of Columbia</option>
            </select>
        </div>

        <div class="form-group">
            <label for="new_zip">Zip</label>
            <input type="text" id="new_zip" name="new_zip" placeholder="Zip" class="form-control">
        </div>

        <div class="form-group">
            <label for="new_country">Country</label>
            <input type="text" id="new_country" name="new_country" placeholder="Country" class="form-control">
        </div>

        <hr style="margin: 2rem 0;">

        <!-- DONATION FIELDS -->
        <div class="form-group">
            <label for="amount">Donation Amount *</label>
            <input type="number" id="amount" name="amount" step="0.01" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="donationdate">Donation Date *</label>
            <input type="date" id="donationdate" name="donationdate" class="form-control" required>
        </div>

        <div class="form-actions" style="margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary">Add Donation</button>
            <a href="/donations" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<style>
.autocomplete {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: none;
}

.autocomplete-item {
    padding: 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.autocomplete-item:hover {
    background-color: #f0f0f0;
}

.autocomplete-item:last-child {
    border-bottom: none;
}
</style>

<script>
(function() {
    const searchInput = document.getElementById('personSearch');
    const resultsDiv = document.getElementById('personResults');
    const personIdInput = document.getElementById('personid');
    const selectedPersonDiv = document.getElementById('selectedPerson');
    const selectedPersonNameSpan = document.getElementById('selectedPersonName');

    let searchTimeout;

    function clearSelection() {
        personIdInput.value = '';
        searchInput.value = '';
        selectedPersonDiv.style.display = 'none';
        resultsDiv.style.display = 'none';
    }

    window.clearSelection = clearSelection;

    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        clearTimeout(searchTimeout);

        if (query.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/people/search?q=${encodeURIComponent(query)}`);
                const results = await response.json();

                resultsDiv.innerHTML = '';

                if (results.length === 0) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                results.forEach(person => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    const name = `${person.firstname || ''} ${person.lastname || ''}`.trim() || 'Unknown';
                    const email = person.email || '';
                    item.textContent = `${name}${email ? ' - ' + email : ''}`;
                    item.onclick = () => {
                        personIdInput.value = person.personid;
                        searchInput.value = `${name}${email ? ' - ' + email : ''}`;
                        selectedPersonNameSpan.textContent = `${name}${email ? ' - ' + email : ''}`;
                        selectedPersonDiv.style.display = 'block';
                        resultsDiv.style.display = 'none';
                    };
                    resultsDiv.appendChild(item);
                });

                resultsDiv.style.display = 'block';
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.style.display = 'none';
            }
        }, 300);
    });

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });
})();
</script>

<%- include('../partials/footer') %>
