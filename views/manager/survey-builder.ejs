<%- include('../partials/header', { title: "Survey Builder", user: user }) %>

<div class="page-header">
    <h1>Survey Builder</h1>
    <p>Create and edit survey questions for events</p>
</div>

<div class="form-container" style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
    <!-- Select Event -->
    <form method="GET" action="/surveys/builder" class="mb-4">
        <div class="form-group">
            <label for="eventid">Select Event</label>
            <select name="eventid" id="eventid" class="form-control" onchange="this.form.submit()">
                <option value="">Choose an event...</option>
                <% events.forEach(e => { %>
                    <option value="<%= e.eventoccurrenceid %>"
                        <%= selectedEvent && selectedEvent.eventoccurrenceid == e.eventoccurrenceid ? 'selected' : '' %>>
                        <%= e.eventname %><% if (e.eventdatetimestart) { %> - <%= new Date(e.eventdatetimestart).toISOString().slice(0,10) %><% } %><% if (e.eventlocation) { %> (<%= e.eventlocation %>)<% } %>
                    </option>
                <% }) %>
            </select>
        </div>
    </form>

    <% if (selectedEvent) { %>

        <div class="mb-4">
            <h3>Editing Survey for: <%= selectedEvent.eventname %></h3>
            <p style="color: var(--text-secondary);">Add, edit, or remove survey questions. Participants will answer these on a 1-5 scale.</p>
        </div>

        <form method="POST" action="/surveys/builder/save">
            <input type="hidden" name="eventid" value="<%= selectedEvent.eventoccurrenceid %>">

            <div class="table-container">
                <table aria-label="Survey Questions">
                    <thead>
                        <tr>
                            <th scope="col">Question</th>
                            <th scope="col" style="width: 100px;">Remove</th>
                        </tr>
                    </thead>
                    <tbody id="questionList">
                        <% if (questions && questions.length > 0) { %>
                            <% questions.forEach((q, idx) => { %>
                                <tr>
                                    <td>
                                        <input type="hidden" name="existing_ids[]" value="<%= q.surveyid || `temp_${idx}` %>">
                                        <input type="text" class="form-control" name="existing_questions[]" value="<%= q.question || q %>" required>
                                    </td>
                                    <td style="text-align: center;">
                                        <input type="checkbox" name="delete_ids[]" value="<%= q.surveyid || `temp_${idx}` %>" title="Mark for deletion">
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr id="empty-row">
                                <td colspan="2" class="text-center" style="color: var(--text-secondary);">
                                    No questions yet. Click "Add Question" to get started.
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <div class="form-actions" style="margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="addQuestion()">Add Question</button>
                <button type="submit" class="btn btn-primary">Save Survey</button>
                <a href="/surveys" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>

    <% } else { %>
        <div class="text-center" style="padding: 3rem; color: var(--text-secondary);">
            <p>Select an event above to create or edit its survey questions.</p>
        </div>
    <% } %>
</div>

<script>
function addQuestion() {
    const questionList = document.getElementById("questionList");
    const emptyRow = document.getElementById("empty-row");
    
    // Remove empty row message if it exists
    if (emptyRow) {
        emptyRow.remove();
    }
    
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>
            <input type="text" class="form-control" name="new_questions[]" placeholder="Enter question text..." required>
        </td>
        <td></td>
    `;
    questionList.appendChild(row);
    
    // Focus on the new input
    const newInput = row.querySelector('input');
    if (newInput) {
        newInput.focus();
    }
}
</script>

<%- include('../partials/footer') %>

