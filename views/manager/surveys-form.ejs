<%- include('../partials/header', { title: (surveyData && surveyData.id) ? 'Edit Survey Template' : 'Create Survey Template', user: user || null }) %>

<div class="page-header">
    <h1><%= (surveyData && surveyData.id) ? 'Edit Survey Template' : 'Create Survey Template' %></h1>
    <p><%= (surveyData && surveyData.id) ? 'Update survey template' : 'Create a survey template for an event. Users who attended will be able to fill it out.' %></p>
</div>

<div class="form-container">
    <form action="<%= (surveyData && surveyData.id) ? '/surveys/' + surveyData.id + '/update' : '/surveys/new' %>" method="POST" id="survey-form">
        <div class="form-group">
            <label for="event_id">Event *</label>
            <select id="event_id" name="event_id" required>
                <option value="">Select event (only events without surveys are shown)</option>
                <% if (events && events.length > 0) { %>
                    <% events.forEach(function(event) { %>
                        <option value="<%= event.EventOccurrenceID || event.eventoccurrenceid %>" 
                            <%= (surveyData && surveyData.event_id == (event.EventOccurrenceID || event.eventoccurrenceid)) ? 'selected' : '' %>>
                            <%= event.displayName || (event.EventName || event.eventname) %>
                        </option>
                    <% }); %>
                <% } else { %>
                    <option value="">No events available (all events already have surveys)</option>
                <% } %>
            </select>
            <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                Only events without surveys are shown. Once created, users who attended this event can fill out the survey.
            </small>
        </div>
        
        <div class="form-group">
            <label>Survey Questions (1-5 Scale) *</label>
            <div id="questions-container">
                <!-- Questions will be added here dynamically -->
            </div>
            <button type="button" id="add-question-btn" class="btn btn-secondary" style="margin-top: 0.5rem;">+ Add Question</button>
            <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 0.5rem;">
                Add questions that users will answer on a 1-5 scale. At least one question is required.
            </small>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Create Survey Template</button>
            <a href="/surveys" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    let questionCount = 0;
    const addQuestionBtn = document.getElementById('add-question-btn');
    const questionsContainer = document.getElementById('questions-container');
    const surveyForm = document.getElementById('survey-form');
    
    function addQuestion(questionText = '', questionId = null) {
        questionCount++;
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-item';
        questionDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-light); border-radius: 8px; background: var(--pink-bg);';
        questionDiv.dataset.questionId = questionId || questionCount;
        
        questionDiv.innerHTML = `
            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Question ${questionCount}</label>
                    <input type="text" name="questions[]" class="question-input" placeholder="Enter question text (e.g., How satisfied were you with this event?)" value="${questionText}" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-light); border-radius: 4px;">
                    <input type="hidden" name="question_ids[]" value="${questionId || ''}">
                </div>
                <button type="button" class="remove-question-btn btn btn-sm btn-danger" style="margin-top: 1.75rem;">Remove</button>
            </div>
        `;
        
        questionsContainer.appendChild(questionDiv);
        
        // Add remove functionality
        questionDiv.querySelector('.remove-question-btn').addEventListener('click', function() {
            if (questionsContainer.children.length > 1) {
                questionDiv.remove();
            } else {
                alert('At least one question is required.');
            }
        });
    }
    
    // Add initial question
    addQuestion();
    
    // Add question button
    addQuestionBtn.addEventListener('click', function() {
        addQuestion();
    });
    
    // Form submission - validate at least one question
    surveyForm.addEventListener('submit', function(e) {
        const questionInputs = document.querySelectorAll('.question-input');
        const hasQuestions = Array.from(questionInputs).some(input => input.value.trim() !== '');
        
        if (!hasQuestions) {
            e.preventDefault();
            alert('Please add at least one question.');
            return false;
        }
        
        // Validate all questions have text
        let allValid = true;
        questionInputs.forEach(input => {
            if (input.value.trim() === '') {
                allValid = false;
            }
        });
        
        if (!allValid) {
            e.preventDefault();
            alert('Please fill in all question fields.');
            return false;
        }
    });
</script>

<style>
    .question-item {
        transition: all 0.2s ease;
    }
    .question-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
</style>

<%- include('../partials/footer') %>
