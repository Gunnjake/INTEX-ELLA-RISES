<%- include('../partials/header', { title: "Add Survey", user: user || null }) %>

<div class="page-header">
    <h1>Add Survey</h1>
    <p>Select an event registration to add a survey</p>
</div>

<% if (messages && messages.length > 0) { %>
    <% messages.forEach(function(message) { %>
        <div class="flash-message flash-<%= message.type %>" style="max-width: 1200px; margin: 1rem auto; padding: 0 2rem;">
            <%= message.text %>
        </div>
    <% }); %>
<% } %>

<div class="form-container" style="max-width: 800px; margin: 0 auto; padding: 0 2rem;">
    <form action="/surveys/new" method="POST">
        <div class="form-group">
            <label for="registrationSearch">Search Event Registration *</label>
            <input type="text" id="registrationSearch" class="form-control" placeholder="Type to search by person name or event name..." autocomplete="off" required>
            <input type="hidden" name="registrationid" id="registrationid" required>
            <div id="searchResults" class="search-results" style="display: none; margin-top: 0.5rem; border: 1px solid var(--border-light); border-radius: 4px; background: white; max-height: 300px; overflow-y: auto; position: absolute; z-index: 1000; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
            <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                Start typing to search for a person or event.
            </small>
        </div>

        <div class="form-actions" style="margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary">Add Survey</button>
            <a href="/surveys" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    // Store all registrations data
    const allRegistrations = <%- JSON.stringify(registrations || []) %>;
    const searchInput = document.getElementById('registrationSearch');
    const hiddenInput = document.getElementById('registrationid');
    const resultsDiv = document.getElementById('searchResults');
    let selectedRegistration = null;

    // Filter and display results as user types
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        if (searchTerm.length === 0) {
            resultsDiv.style.display = 'none';
            hiddenInput.value = '';
            selectedRegistration = null;
            return;
        }

        // Filter registrations
        const filtered = allRegistrations.filter(r => {
            const personName = (r.personname || '').toLowerCase();
            const eventName = (r.eventname || '').toLowerCase();
            const eventDate = (r.eventdate || '').toLowerCase();
            const searchText = `${personName} ${eventName} ${eventDate}`;
            return searchText.includes(searchTerm);
        });

        // Display results
        if (filtered.length === 0) {
            resultsDiv.innerHTML = '<div style="padding: 1rem; color: var(--text-secondary);">No matches found</div>';
            resultsDiv.style.display = 'block';
            hiddenInput.value = '';
            selectedRegistration = null;
        } else {
            resultsDiv.innerHTML = filtered.map(r => {
                const displayText = `${r.personname} – ${r.eventname} (${r.eventdate})`;
                return `<div class="search-result-item" data-registrationid="${r.registrationid}" style="padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border-light); transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='var(--pink-bg)'" onmouseout="this.style.backgroundColor='white'">${displayText}</div>`;
            }).join('');
            resultsDiv.style.display = 'block';
            
            // Add click handlers
            resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const registrationId = this.getAttribute('data-registrationid');
                    selectedRegistration = allRegistrations.find(r => r.registrationid == registrationId);
                    searchInput.value = `${selectedRegistration.personname} – ${selectedRegistration.eventname} (${selectedRegistration.eventdate})`;
                    hiddenInput.value = registrationId;
                    resultsDiv.style.display = 'none';
                });
            });
        }
    });

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        if (!hiddenInput.value) {
            e.preventDefault();
            alert('Please select a registration from the search results.');
            searchInput.focus();
            return false;
        }
    });
</script>

<style>
    .form-group {
        position: relative;
    }
    .search-result-item:hover {
        background-color: var(--pink-bg) !important;
    }
</style>

<%- include('../partials/footer') %>
