<%- include('../partials/header', { title: 'Post-Event Surveys - Ella Rises', user: typeof user !== 'undefined' ? user : null }) %>

<div class="page-header">
    <h1>Post-Event Surveys</h1>
    <p>View survey responses grouped by event</p>
</div>

<% if (messages && messages.length > 0) { %>
    <% messages.forEach(function(message) { %>
        <div class="flash-message flash-<%= message.type %>" style="max-width: 1200px; margin: 1rem auto; padding: 0 2rem;">
            <%= message.text %>
        </div>
    <% }); %>
<% } %>

<div class="search-container">
    <label for="search-input" class="sr-only">Search events</label>
    <input type="text" id="search-input" class="search-input" placeholder="Search events by name..." aria-label="Search events by name">
    <a href="/surveys/new" class="btn btn-primary" aria-label="Add new survey">Add New Survey</a>
</div>

<div class="table-container" role="region" aria-label="Surveys by event table">
    <table aria-label="Surveys by Event">
        <thead>
            <tr>
                <th scope="col">Event Name</th>
                <th scope="col">Surveys</th>
                <th scope="col">Avg Satisfaction</th>
                <th scope="col">Avg Usefulness</th>
                <th scope="col">Avg Recommendation</th>
            </tr>
        </thead>
        <tbody id="surveys-table-body">
            <% if (typeof surveyGroups !== 'undefined' && surveyGroups.length > 0) { %>
                <% surveyGroups.forEach(function(group) { %>
                    <tr>
                        <td><%= group.eventName || 'N/A' %></td>
                        <td><%= group.survey_count || 0 %></td>
                        <td><%= group.avg_satisfaction ? group.avg_satisfaction.toFixed(2) : 'N/A' %></td>
                        <td><%= group.avg_usefulness ? group.avg_usefulness.toFixed(2) : 'N/A' %></td>
                        <td><%= group.avg_recommendation ? group.avg_recommendation.toFixed(2) : 'N/A' %></td>
                    </tr>
                <% }); %>
            <% } else { %>
                <tr>
                    <td colspan="5" class="text-center" role="status" aria-live="polite">No survey data found. Surveys will appear here once submitted.</td>
                </tr>
            <% } %>
        </tbody>
    </table>
</div>

<script>
    // Search functionality with screen reader support
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#surveys-table-body tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const isVisible = text.includes(searchTerm);
                row.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });
            
            const status = document.querySelector('#surveys-table-body [role="status"]');
            if (status && visibleCount > 0) {
                status.textContent = `${visibleCount} event${visibleCount === 1 ? '' : 's'} found`;
            }
        });
    }
</script>

<%- include('../partials/footer') %>
